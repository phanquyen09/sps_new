<script type="text/javascript" src="../js/base.js"></script>
<script type="text/javascript" src="../js/prototype.js"></script>
<script type="text/javascript" src="../js/effects.js"></script>
<script type="text/javascript" src="../js/window.js"></script>
<script type="text/javascript" src="../js/debug.js"></script>
<script type="text/javascript" src="../js/ES_gyomu.js"></script>
<script src="../js/custom_ui/jquery/jquery-1.7.1.min.js"></script>
<link href="../css/themes/default.css" rel="stylesheet" type="text/css" > </link>
<link href="../css/themes/theme1.css" rel="stylesheet" type="text/css" > </link>
<link href="../css/themes/mac_os_x.css" rel="stylesheet" type="text/css" > </link>
<link href="../css/themes/alphacube.css" rel="stylesheet" type="text/css" > </link>
<link href="../css/themes/darkX.css" rel="stylesheet" type="text/css" > </link>
<link href="../css/themes/spread.css" rel="stylesheet" type="text/css" > </link>
<link href="../css/themes/alert.css" rel="stylesheet" type="text/css" > </link>
<link href="../css/themes/alert_lite.css" rel="stylesheet" type="text/css" > </link>
<script language="JavaScript">
var $j = jQuery.noConflict();
<!--
<TMPL_VAR NAME=HOVER_ALERT>
//-->
</script>
<table width="100%"  border="0" cellpadding="0" cellspacing="0" bgcolor="#FFFFFF">
<form name="STATUS" method="POST" action="shop-status.cgi">
<input type="hidden" name="CMD" value="EDT">
                          <tr>
                            <td width="12"><table width="50%" align="right"  border="0" cellspacing="0" cellpadding="0" height="20" bgcolor="#0093C9">
                                <tr>
                                  <td><img src="../imgs/spc.gif"></td>
                                </tr>
                            </table></td>
<td align="left" class="midashi">お店の開店・閉店の設定を行います</td>
<td align="right" class="midashi"><a href="https://help.shopserve.jp/help/shop-status.php" target="manual"><img src="../imgs/help_link.gif" alt="この機能のヘルプをみる" align="center" height="22" width="153" border="0"></a></td>
                          </tr>
                        </table>
                          <img src="../imgs/spc.gif" width="5" height="5">
                          <table width="100%"  border="0" cellpadding="0" cellspacing="0" class="table-padding-textarea-default">
                            <tr>
                              <td align="left" class="main-table">
                                <div class="infoArea table_bg">
                                  お店の開店、閉店に関する設定をします。
                                </div>
                                <div style="border:2px violet solid;padding:8px;line-height:normal;">
                                はじめて開店する場合は、購入者の視点でお店ページをチェックしながら、テスト注文(*)を行い、受注が入ったあとの取引の流れを確認しておきましょう。
                                <br><br>
                                <span style="font-size:90%">
                                  <table>
                                    <tr>
                                      <td>(*)</td>
                                      <td>テスト注文は、必ず、以下の手順で行ってください。指定の方法以外で行うと、<font color=red><b>注文処理手数料<TMPL_VAR NAME=OneOrderPrice>円</b>(税込<TMPL_VAR NAME=OneOrderPriceTaxIn>円)<b>/1件<b/></font>が発生します。</td>
                                    </tr>
                                    <tr>
                                      <td>&nbsp;</td>
                                      <td><a href="https://help.shopserve.jp/manual/013/" target="_blank">⇒テスト注文を行う手順</a></td>
                                    </tr>
                                  </table>
                                </span>
                                </div>
                                <br>
<TMPL_LOOP NAME=ERR_MSG>
<font color="red">&nbsp;・<TMPL_VAR NAME=MSG></font><br>
</TMPL_LOOP>
<table width="100%"  border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                  <td><table width="100%"  border="0" cellpadding="0" cellspacing="2" class="item-box">
                                    <tr align="center">
                                      <td colspan="2" class="item-name02">お店の開店・閉店設定</td>
                                    </tr>
                                    <tr>
                                      <td class="item-name">モード設定</td>
                                      <td class="item"><table border="0" cellspacing="0" cellpadding="0">
                                          <tr>
                                            <td><input name="Status" type="radio" value="O" id="open01" onclick="changeDisp('O');" <TMPL_IF STATUSO>checked</TMPL_IF> <TMPL_IF HOVER_ALERT>disabled</TMPL_IF>>
                                            </td>
                                            <td><label for="open01">開店にする</label></td>
                                          </tr>
                                          <tr>
                                            <td><input name="Status" type="radio" value="L" id="open04" onclick="changeDisp('L');" <TMPL_IF STATUSL>checked</TMPL_IF> <TMPL_IF HOVER_ALERT>disabled</TMPL_IF>>
                                            </td>
                                            <td><label for="open04">開店にする&nbsp;(ログイン制限付き)</label></td>
                                          </tr>
                                          <tr id="userBlock" style="display:none;">
                                            <td>
                                              &nbsp;
                                            </td>
                                            <td style="padding-bottom:6px;">
                                              <table border="0" cellpadding="0" cellspacing="0">
                                                <tr>
                                                  <td align="right">ユーザー名：</td>
                                                  <td>半角英数字3〜8文字、「-」「_&nbsp;」使用可</td>
                                                </tr>
                                                <tr>
                                                  <td align="right">パスワード：</td>
                                                  <td>半角英数字記号3〜32文字</td>
                                                </tr>
                                              </table>
                                              <div id="saveConfirmMsg" style="display:none;"><font color="red">追加・変更・削除を保存する場合は、［設定を保存する］をクリックしてください。</font></div>
                                              <table id="userTable" border="0" cellpadding="5" cellspacing="2" class="item-box">
                                                <tr align="center" class="item-name">
                                                  <td width="105px">ユーザー名</td>
                                                  <td width="205px">パスワード</td>
                                                  <td width="70px">操作</td>
                                                </tr>
                                                <tr id="addUserRow" align="center" class="item" style="display:none;">
                                                  <td><input type="text" name="username" size="12" maxlength="8" style="ime-mode:disabled"></td>
                                                  <td><input type="text" name="pwd" size="28" maxlength="32" style="ime-mode:disabled"></td>
                                                  <td><input name="adduser" type="button" id="adduser" value="追加する" onClick="addUser(document.STATUS);"></td>
                                                </tr>
                                                <TMPL_LOOP NAME=Userslist>
                                                  <tr align="center" class="item">
                                                    <td><TMPL_VAR NAME=UserName><input type="hidden" name="editUsernameList" value="<TMPL_VAR NAME=UserName>"></td>
                                                    <td><input type="text" name="editPwdList" size="28" maxlength="32" style="ime-mode:disabled;" onBlur="changePwdAlert(this);" onKeyup="changePwd(this);" value="<TMPL_VAR NAME=Pwd>"></td>
                                                    <td><input name="deluser" type="button" id="deluser" value="削除する" onClick="delUser(this);"></td>
                                                  </tr>
                                                </TMPL_LOOP>
                                              </table>
                                            </td>
                                          </tr>
                                          <tr>
                                            <td><input name="Status" type="radio" value="P" id="open02" onclick="changeDisp('P');" <TMPL_IF STATUSP>checked</TMPL_IF>>
                                            </td>
                                            <td><label for="open02">開店準備にする</label></td>
                                          </tr>
                                          <tr>
                                            <td><input name="Status" type="radio" value="C" id="open03" onclick="changeDisp('C');" <TMPL_IF STATUSC>checked</TMPL_IF>>
                                            </td>
                                            <td><label for="open03">一時閉店にする</label></td>
                                          </tr>
                                          <tr>
                                            <td>
                                              <TMPL_IF UPDATED>
                                                <TMPL_IF STATUSO><img src="../func00/click_logger.php?type=OPEN_STR" alt="" /></TMPL_IF>
                                                <TMPL_IF STATUSL><img src="../func00/click_logger.php?type=LOGIN_STR" alt="" /></TMPL_IF>
                                                <TMPL_IF STATUSP><img src="../func00/click_logger.php?type=PREP_STR" alt="" /></TMPL_IF>
                                                <TMPL_IF STATUSC><img src="../func00/click_logger.php?type=CLOS_STR" alt="" /></TMPL_IF>
                                              </TMPL_IF>
                                                &nbsp;
                                            </td>
                                            <td>
                                                <div><textarea name="CloseMsg" rows="5" wrap="VIRTUAL" class="def-line"><TMPL_VAR NAME=CLOSEMSG></textarea></div>
                                                ※HTMLタグ利用可
                                            </td>
                                          </tr>
                                      </table></td>
                                    </tr>
                                  </table><br></td>
                                </tr>
                                <tr>
                                    <td style="text-align:center;"><input name="set" type="button" id="set" value="設定を保存する" onClick="saveStatus();"></td>
                                </tr>
                              </table></td>
                            </tr>
                        </table>
                      </td>
                    </tr>
</form>
<script type="text/javascript">
  // 初期表示
  (function initDisp () {
    // ユーザーリストの件数取得
    maxUsersList = <TMPL_VAR NAME=MaxUserslist>;
    // 20件未満ならユーザーを追加するための入力窓を表示
    if(maxUsersList < 20){
      document.getElementById('addUserRow').style.display = "";
    }

    for(var i=0 ; i<document.STATUS.Status.length ; i ++){
      // 設定が「開店にする (ログイン制限付き)」の時
      if(document.STATUS.Status[i].checked && document.STATUS.Status[i].value == 'L'){
        // ユーザー名とパスワードのテーブルを表示
        document.getElementById('userBlock').style.display = "";
      }
    }
  }());

  // ラジオボタン選択時の表示切り替え
  function changeDisp (STATUS){
    switch(STATUS){
      // 開店にする (ログイン制限付き)
      case 'L':
        // ユーザー名とパスワードのテーブルを表示
        document.getElementById('userBlock').style.display = "";
        break;
      default:
        // ユーザー名とパスワードのテーブルを非表示
        document.getElementById('userBlock').style.display = "none";
        break;
    }
  }

  // 「設定を保存する」押下時
  function saveStatus (){
    for (var i=0 ; i<document.STATUS.Status.length ; i ++) {
      // 設定が「開店にする (ログイン制限付き)」の時
      if (document.STATUS.Status[i].checked && document.STATUS.Status[i].value == 'L') {
        // テーブルのユーザー名とパスワードを取得
        var editUsernameList = document.getElementsByName("editUsernameList");
        var editPwdList = document.getElementsByName("editPwdList");
        // ユーザーが0件の場合エラー
        if (editUsernameList.length == 0) {
          alert('ユーザーを追加してください。');
          return;
        }

        // ユーザー名は追加後編集不可、パスワードは編集ができるので入力値のチェック
        var errMessage = '';
        var errMessageArr = new Array();
        var errRow = new Array();
        for (var j=0 ; j<editPwdList.length ; j++){
          errMessageArr = checkPwd(editPwdList[j], errMessageArr);
          if (errMessageArr.length > errRow.length) {
            // 一番最初にエラーだったテキストボックスにfocus
            if (errRow.length === 0){
              editPwdList[j].focus();
            }
            errRow.unshift((j+1) + '行目：'); // エラーがあった行を配列に格納
          }
        }
        // エラーメッセージをアラートで画面に表示
        if (errMessageArr.length > 0) {
          for (var j=errMessageArr.length ; j>=0 ; j--) {
            if (errMessageArr[j] != undefined) {
              errMessage += errRow[j] + errMessageArr[j] + "\n";
            }
          }
          alert(errMessage);
          return;
        }

        // 「設定を保存する」ボタンを何度も押された時に送信用のフォーム部品生成が何度も走らないように
        // 必要な送信用のフォーム部品が無い時だけ処理が動くように判定
        if (document.getElementsByName("usernameList[]")[0] == null) {
          for (var j=0 ; j<editUsernameList.length ; j++){
            makeSendData('usernameList[]', editUsernameList[j].value);
          }
          for (var j=0 ; j<editPwdList.length ; j++){
            makeSendData('pwdList[]', editPwdList[j].value);
          }
        }
      }
    }
    document.STATUS.submit();
  }

  // 送信用のフォーム部品を生成
  function makeSendData( name, value ){
    var sendData = document.createElement('input');
    sendData.type = 'hidden';
    sendData.name = name;
    sendData.value = value;
    document.STATUS.appendChild(sendData); 
  }

  // ユーザー追加
  function addUser (frm) {
    var errMessage = '';
    var errMessageArr = new Array();
    var errCnt = 0;

    // ユーザー名とパスワードの入力値チェック
    frm.pwd.value = frm.pwd.value.replace(/\s/g, ""); // 空白を削除
    errMessageArr = checkPwd(frm.pwd, errMessageArr);
    if (errMessageArr.length > errCnt) frm.pwd.focus();
    errCnt = errMessageArr.length;
    errMessageArr = checkUsername(frm.username, errMessageArr, 1);
    if (errMessageArr.length > errCnt) frm.username.focus();
    // エラーメッセージをアラートで画面に表示
    if (errMessageArr.length > 0) {
      for (var i=0 ; i<=errMessageArr.length ; i++) {
        if (errMessageArr[i] != undefined) {
          errMessage += errMessageArr[i] + "\n";
        }
      }
      alert(errMessage);
      return;
    }

    // 入力値チェックで問題がなければ入力したユーザー名とパスワードをテーブルに追加
    // テーブル取得
    var table = document.getElementById('userTable');
    // 行を追加
    var row = table.insertRow(2);
    // クラスとスタイルの適用
    row.className = 'item';
    row.style.textAlign = 'center';
    // セルの挿入
    var cell1 = row.insertCell(-1);
    var cell2 = row.insertCell(-1);
    var cell3 = row.insertCell(-1);
 
    // セルの内容入力
    cell1.innerHTML = frm.username.value + '<input type="hidden" name="editUsernameList" value="' + frm.username.value + '">';
    cell2.innerHTML = '<input type="text" name="editPwdList" size="28" maxlength="32" style="ime-mode:disabled" onKeyup="changePwd(this);" onBlur="changePwdAlert(this);" value="' + htmlEscape(frm.pwd.value) + '">';
    cell3.innerHTML = '<input type="button" name="deluser" id="deluser" value="削除する" onClick="delUser(this)">';

    // 入力欄を空に
    frm.username.value = '';
    frm.pwd.value = '';
    // 連続でユーザーを追加する時便利なようにユーザー名の入力欄にフォーカス
    frm.username.focus();

    // ユーザーリスト取得
    var editUsernameList = document.getElementsByName("editUsernameList");
    // ユーザーリストが20件ならユーザーを追加するための入力窓を非表示
    if(editUsernameList.length == 20){
      document.getElementById('addUserRow').style.display = "none";
    }
    saveConfirm();
  }

  // ユーザー削除
  function delUser (obj) {
    // [削除する]ボタンを押下された行を取得
    var tr = obj.parentNode.parentNode;
    // trのインデックスを取得して行を削除する
    tr.parentNode.deleteRow(tr.sectionRowIndex);

    // ユーザーリスト取得
    var editUsernameList = document.getElementsByName("editUsernameList");
    // ユーザーリストが20件未満ならユーザーを追加するための入力窓を表示
    if(editUsernameList.length < 20){
      document.getElementById('addUserRow').style.display = "";
    }
    saveConfirm();
  }

  // パスワードの入力値チェックをリアルタイムに行いその結果で行の色を変える
  function changePwd (obj){
    var td = obj.parentNode.parentNode;       // onkeyupイベントのあったテキストボックスの行を取得
    // 空白があれば削除
    if ( obj.value.match( /\s/ ) ) {
      obj.value = obj.value.replace(/\s/g, "");
    }
    // 初期値と入力値が不一致の場合(変更があった場合)
    if (obj.defaultValue != obj.value) {
      var errMessageArr = new Array();
      // 入力値チェック
      errMessageArr = checkPwd(obj, errMessageArr);
      // エラー
      if (errMessageArr.length > 0) {
        td.style.backgroundColor = "#FFEEEE"; 
      } else {
        td.style.backgroundColor = "#FFFFFF";
      }
      saveConfirm();
    }
    // 初期値と入力値が一致(変更がない)場合
    else {
      td.style.backgroundColor = "#FFFFFF";
    }
  }

  // 変更されたパスワードの入力値チェックを行いエラーの場合アラートを表示
  function changePwdAlert (obj){
    // 空白があれば削除
    if ( obj.value.match( /\s/ ) ) {
      obj.value = obj.value.replace(/\s/g, "");
    }
    // onBlur時に編集前と編集後の値で差があるときだけ入力値チェックを行う処理
    // パスワードの変更欄のフォーカスが外れた時(onBlur)
    // その時入力されていた値をdataset-chkに格納してパスワードの変更欄のinputタグに埋め込む
    // 次にまた同じパスワードの変更欄のフォーカスが外れた時
    // 編集前(dataset-chk)と編集後の現在の値(obj.value)を比較し
    // 値が異なる時だけ入力値チェックを行いエラー時にはアラートを表示する
    if (undefined == obj.dataset.chk || obj.dataset.chk !== obj.value) {
      var errMessage = '';
      var errMessageArr = new Array();
      // 入力値チェック
      errMessageArr = checkPwd(obj, errMessageArr);
      // エラーメッセージをアラートで画面に表示
      if (errMessageArr.length > 0) {
        for (var i=0 ; i<=errMessageArr.length ; i++) {
          if (errMessageArr[i] != undefined) {
            errMessage += errMessageArr[i] + "\n";
          }
        }
        alert(errMessage);
        // エラー箇所にfocusが移るように対応
        setTimeout(function(){
            obj.focus();
            // Firefoxのみアラート後テキスト選択状態になってしまうので、選択を解除
            if ( chk_web("Firefox") ) {
              window.getSelection().removeAllRanges();
            }
        }, 1);
      }
    }
    obj.dataset.chk = obj.value;
  }

  // ユーザー名の入力値チェック
  function checkUsername (username, errMessageArr, add){
    // NULLチェック
    if (username.value == '') {
      errMessageArr.unshift('ユーザー名が入力されていません。ユーザー名は3〜8文字以内で入力してください。');
    }
    // 不正文字チェック
    else if (!checkValidUsername(username.value)){
      errMessageArr.unshift('ユーザー名に利用できない文字が含まれています。ユーザー名は半角英数字、または「-」「_ 」で設定してください。');
    }
    // 文字数チェック
    else if (username.value.length < 3 || username.value.length > 8) {
      errMessageArr.unshift('ユーザー名は3〜8文字以内で入力してください。');
    }
    // ユーザー名重複チェック
    else if (add === 1 && !checkUniqueUserName(username.value)){
      errMessageArr.unshift("ユーザー名「" + username.value + '」はすでに登録されています。違うユーザー名を指定してください。');
    }

    return errMessageArr;
  }

  // パスワードの入力値チェック
  function checkPwd (pwd, errMessageArr){
    // NULLチェック
    if (pwd.value == '') {
      errMessageArr.unshift('パスワードが入力されていません。パスワードは3〜32文字以内で入力してください。');
    }
    // 不正文字チェック
    else if (!checkGaiji(pwd.value) || !checkZenkaku(pwd.value)){
      errMessageArr.unshift('パスワードに利用できない文字が含まれています。パスワードは半角英数･記号で設定してください。');
    }
    // 文字数チェック
    else if (pwd.value.length < 3 || pwd.value.length > 32) {
      errMessageArr.unshift('パスワードは3〜32文字以内で入力してください。');
    }

    return errMessageArr;
  }

  // ユーザー名に半角英数字と「-」「_ 」以外の文字があればエラー
  function checkValidUsername (username){
    var pattern = /^[a-zA-Z0-9_\-]+$/;

    if (username.match(pattern)) {
      return true;
    } else {
      return false;
    }
  }

  // 追加するusernameが重複していないかチェック
  function checkUniqueUserName (str){
    var tableUsersList = document.getElementsByName("editUsernameList");
    for (var i=0 ; i<tableUsersList.length ; i++) {
      if (tableUsersList[i].value === str) {
        return false;
      }
    }
    return true;
  }

  // パスワードに機種依存文字、全角文字があればエラー
  function checkGaiji (strTarget){
    var consChar = /[´↓きキΝЛ┃悪鵜沖貝喚記境鍬賢広梱鮫辞臭将性銑足鱈牒鏑騰猫鉢畢吻豊稔有劉廊亅儉勠哭圻姚岫澂爿甅皚祗筬絖罩膈茘薛雖覘讚蹲遶錢癶瓣薛鶚槇紜蘗椨∵∩∪｡｢｣､･ｦｧｨｩｪｫｬｭｮｯｰｱｲｳｴｵｶｷｸｹｺｻｼｽｾｿﾀﾁﾂﾃﾄﾅﾆﾇﾈﾉﾊﾋﾌﾍﾎﾏﾐﾑﾒﾓﾔﾕﾖﾗﾘﾙﾚﾛﾜﾝﾞﾟ]/;
    if ( strTarget.match( consChar ) ) {
       return false;
    } else {
       return true;
    }
  } 
  function checkZenkaku (strTarget){
    var len;
    for(var i=0; i<strTarget.length; i++){
      /* 1文字ずつ文字コードをエスケープし、その長さが4文字以上なら全角 */
      len = escape(strTarget.charAt(i)).length;
      if(len>=4){
        return false;
      }
    }
    return true;
  }

  // HTML特殊文字のエスケープ
  function htmlEscape (strTarget){
    strTarget = strTarget.replace(/&/ig,"&amp;");
    strTarget = strTarget.replace(/</ig,"&lt;");
    strTarget = strTarget.replace(/>/ig,"&gt;");
    strTarget = strTarget.replace(/"/ig,"&quot;");
    return strTarget;
  }

  // クロースブラウジングのために必要なブラウザチェック
  function chk_web (browser) {
    if ( browser === "MSIE 8" ) {
      if ( navigator.userAgent.match("MSIE 7") != null )
          return chk_web("MSIE 7");
    }

    return navigator.userAgent.match(browser);
  }

  // ユーザーリストに追加・変更・削除があった時に
  // [設定を保存する]ボタンをクリックしないと保存されない旨を注意文言で表示
  function saveConfirm () {
    if ($j("#saveConfirmMsg").is(":hidden")) {
      $j("#saveConfirmMsg").slideDown("normal");
    }
  }

</script>